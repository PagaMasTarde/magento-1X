<?php
/**
 * @var int $simulatorType
 * @var bool $enabled
 * @var string $publicKey
 */
if ($pagantisIsEnabled && $pagantisSimulatorIsEnabled) {
?>
    <script>
        function findPriceSelector()
        {
            //Trying to find the product price selector
            var priceDOM = document.querySelector('[id^="product-price"]');
            if (priceDOM != null) {
                return '[id^="product-price"]';
            }

            //Keep default for checkout price.
            return 'default';
        }

        function findQuantitySelector()
        {
            var quantityDOM = document.querySelector('.qty-wrapper #qty');
            if (quantityDOM != null) {
                return '.qty-wrapper #qty';
            }

            return 'default';
        }

        function loadSimulator()
        {
            if (<?=$locale;?> == 'ES') {
                alert('es selected');
            }
            if (typeof pgSDK != 'undefined') {
                var price = null;
                var quantity = null;
                var positionSelector = '<?=$pagantisCSSSelector;?>';
                var priceSelector = '<?=$pagantisPriceSelector;?>';
                var quantitySelector = '<?=$pagantisQuantitySelector;?>';

                if (positionSelector === 'default') {
                    positionSelector = '.PagantisSimulator';
                }

                if (priceSelector === 'default') {
                    priceSelector = findPriceSelector();
                    if (priceSelector === 'default') {
                        price = '<?=$amount;?>';
                    }
                }

                if (quantitySelector === 'default') {
                    quantitySelector = findQuantitySelector();
                    if (quantitySelector === 'default') {
                        quantity = '1'
                    }
                }

                pgSDK.product_simulator = {};
                pgSDK.product_simulator.id = 'product-simulator';
                pgSDK.product_simulator.publicKey = '<?=$pagantisPublicKey;?>';
                pgSDK.product_simulator.selector = positionSelector;
                pgSDK.product_simulator.numInstalments = '<?=$pagantisQuotesStart;?>';
                pgSDK.product_simulator.type = <?=$pagantisSimulatorType;?>;
                pgSDK.product_simulator.skin = <?=$pagantisSimulatorSkin;?>;
                pgSDK.product_simulator.position = <?=$pagantisSimulatorPosition;?>;

                if (priceSelector !== 'default') {
                    pgSDK.product_simulator.itemAmountSelector = priceSelector;
                }
                if (quantitySelector !== 'default' && quantitySelector !== 'none') {
                    pgSDK.product_simulator.itemQuantitySelector = quantitySelector;
                }
                if (price != null) {
                    pgSDK.product_simulator.itemAmount = price;
                }
                if (quantity != null) {
                    pgSDK.product_simulator.itemQuantity = quantity;
                }

                pgSDK.simulator.init(pgSDK.product_simulator);
                clearInterval(window.PSSimulatorId);
            }
        }
        window.PSSimulatorId = setInterval(function () {
            loadSimulator();
        }, 2000);
    </script>
    <div id="pagantis-simulator-product-page" class="PagantisSimulator"></div>
<?php
}
?>
